name: Deploy to Staging

on:
  push:
    branches: [ develop ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/develop'

    steps:
      - uses: actions/checkout@v3

      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.STAGING_DEPLOY_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ secrets.STAGING_HOST }} >> ~/.ssh/known_hosts 2>/dev/null

      - name: Deploy via SSH
        run: |
          ssh -i ~/.ssh/id_rsa ${{ secrets.STAGING_USER }}@${{ secrets.STAGING_HOST }} << 'DEPLOY_SCRIPT'
            set -e
            echo "ðŸš€ Deploying SecureTrack to staging..."
            cd /app/securetrack || exit 1

            git pull origin develop
            source venv/bin/activate
            pip install -r requirements.txt
            cd src
            python manage.py migrate
            python manage.py collectstatic --noinput
            cd ..
            sudo systemctl restart securetrack
            sudo systemctl restart nginx

            sleep 2
            curl -f http://localhost:8000/health/ && echo "âœ… Health check passed"
          DEPLOY_SCRIPT

      - name: Run smoke tests
        run: |
          sleep 5
          echo "ðŸ§ª Running smoke tests..."
          STAGING_URL="${{ secrets.STAGING_URL }}"
          curl -f "${STAGING_URL}/health/" -w "\nâœ… Health: %{http_code}\n"
